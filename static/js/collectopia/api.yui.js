collectopia={isDefined:function(a){return typeof(a)!="undefined"},isNull:function(a){return(isDefined(a)&&(a==null))},isString:function(a){return typeof(a)=="string"},isObject:function(a){return typeof(a)=="object"},isArray:function(a){return jQuery.isArray(a)},isFunction:function(a){return jQuery.isFunction(a)},namespace:function(c){if(typeof(c)=="string"){c=c.split(".")}var b=window;for(var a in c){if(!collectopia.isDefined(b[c[a]])){b[c[a]]={}}b=b[c[a]]}return b},uuidV4:function(){var b=[],c="0123456789ABCDEF";for(var a=0;a<36;a++){b[a]=Math.floor(Math.random()*16)}b[14]=4;b[19]=(b[19]&3)|8;for(var a=0;a<36;a++){b[a]=c[b[a]]}b[8]=b[13]=b[18]=b[23]="-";return b.join("")},uuid:this.uuidV4,api:{init:function(a){collectopia.api._server_url=a;if(a[a.length-1]!="/"){collectopia.api._server_url+="/"}},furl:function(a){if(a[0]=="/"){a=a.slice(1)}return collectopia.api._server_url+a}}};collectopia.api.Error=function(b,a){this.error=b;this.fields=a};collectopia.api.Form=function(c,a,b){jQuery.extend(this,c);this.object=a;this.submit_action=b};collectopia.api.Form.prototype.getObject=function(){return this.object};collectopia.api.Form.prototype.submit=function(c,d,a){var b=this;this.object.clone().update(c)[this.submit_action](function(e){b.object.update(e.getData(),e.getOptions());if(collectopia.isFunction(d)){d.call(b,b)}},function(e){if(collectopia.isFunction(a)){a.call(b,e)}})};collectopia.api.Place=function(b,a){this.update(b,a)};collectopia.api.Place.prototype.serialize=function(){return jQuery.param(this.getData())};collectopia.api.Place.prototype.getData=function(){data={};for(var a in this){if(collectopia.isFunction(this[a])){continue}if(a=="options"){continue}if(a[0]=="_"){continue}data[a]=this[a]}return jQuery.extend(true,{},data)};collectopia.api.Place.prototype.getOptions=function(){return jQuery.extend(true,{},this.options)};collectopia.api.Place.prototype.clone=function(){return new collectopia.api.Place(this.getData(),this.getOptions())};collectopia.api.Place.prototype.update=function(c,a){var b=this.options;jQuery.extend(this,c,{});this.options=b;if(collectopia.isObject(this.photos)){this.photos=this.photos.map(function(d){return new collectopia.api.Photo(d)})}this.options=jQuery.extend({skip_marker_cache:false},this.options,a);return this};collectopia.api.Place.prototype._process_reply_place=function(b,c,a){if(collectopia.isDefined(b.error)){if(collectopia.isFunction(a)){a.call(this,new collectopia.api.Error(b.error,b.fields))}}else{this.update(b);if(collectopia.isFunction(c)){c.call(this,this)}}};collectopia.api.Place.prototype._process_fail=function(b,a){if(collectopia.isFunction(a)){a.call(this,new collectopia.api.Error(b))}};collectopia.api.Place.prototype.reqCreate=function(c,b){if(collectopia.isDefined(this.id)){return false}var a=this;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/+new"),data:this.getData(),success:function(d){a.options.skip_marker_cache=true;a._process_reply_place(d,c,b)},error:function(d,e){a._process_fail(e,b)}});return this};collectopia.api.Place.prototype.reqCreateForm=function(c,b){if(collectopia.isDefined(collectopia.api.Place._cache_reqCreateForm_data)){c.call(this,new collectopia.api.Form(collectopia.api.Place._cache_reqCreateForm_data,this,"reqCreate"));return}var a=this;jQuery.ajax({type:"GET",url:collectopia.api.furl("/api/place/+new"),success:function(d){if(collectopia.isFunction(c)){collectopia.api.Place._cache_reqCreateForm_data=d;c.call(a,new collectopia.api.Form(d,a,"reqCreate"))}},error:b});return this};collectopia.api.Place.prototype.reqUpdate=function(c,b){if(!collectopia.isDefined(this.id)){return false}var a=this;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/@"+this.id+"/+edit"),data:this.getData(),success:function(d){a.options.skip_marker_cache=true;a._process_reply_place(d,c,b)},error:function(d,e){a._process_fail(e,b)}});return this};collectopia.api.Place.prototype.reqUpdateForm=function(c,b){var a=this;jQuery.ajax({type:"GET",url:collectopia.api.furl("/api/place/@"+this.id+"/+edit"),success:function(d){if(collectopia.isFunction(c)){c.call(a,new collectopia.api.Form(d,a,"reqUpdate"))}},error:b});return this};collectopia.api.Place.prototype.reqDelete=function(b,a){if(!collectopia.isDefined(this.id)){return false}jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/@"+escape(this.id)+"/+delete"),data:{id:this.id},success:function(c){if(typeof b=="function"){b.call(place)}},error:a});return this};collectopia.api.Place.prototype.reqRate=function(c,d,b){if(!collectopia.isDefined(this.id)){return false}var a=this;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/@"+escape(this.id)+"/+rate"),data:{id:this.id,rate:c},success:function(e){a._process_reply_place(e,d,b)},error:function(e,f){a._process_fail(f,b)}});return this};collectopia.api.Place.prototype.getMarkerImage=function(){return new collectopia.api.MarkerImage(this.markerpack_hash,this.markerpack_index,false,this.options.skip_marker_cache)};collectopia.api.Place.prototype.getFocusedMarkerImage=function(){return new collectopia.api.MarkerImage(this.markerpack_hash,this.markerpack_index,true,this.options.skip_marker_cache)};collectopia.api.Place.prototype.getVideoUrls=function(){if(typeof this.video_url!=undefined){var b=this.video_url.split(":"),a={};if(a[0]=="youtube"){a.swf="http://www.youtube-nocookie.com/v/"+video[1]+"?autoplay=1&fs=1";a.thumb="http://img.youtube.com/vi/"+video[1]+"/1.jpg";return a}}};collectopia.api.Photo=function(a){jQuery.extend(this,{name:"noname",width:0,height:0,size:0},a)};collectopia.api.Photo.prototype.isTemporary=function(){return collectopia.isDefined(this.secret)};collectopia.api.Photo.prototype.getUrl=function(){return collectopia.api.furl("/data/photos/"+this.hash+".jpg")};collectopia.api.Photo.prototype.getThumbUrl=function(b,a){if(collectopia.isDefined(this.thumb_url)){return this.thumb_url}b=collectopia.isDefined(b)?b:154;a=collectopia.isDefined(a)?a:115;return collectopia.api.furl("/data/photos/"+encodeURIComponent(this.hash)+"_thumb_"+encodeURIComponent(b)+"x"+encodeURIComponent(a)+".jpg")};collectopia.api.Photo.prototype.reqDelete=function(d,a){if(!this.isTemporary()){return}var b=this;var c={type:"POST",url:collectopia.api.furl("/api/photo/"+encodeURIComponent(this.secret)+"/+delete-temp"),data:{secret:this.secret},success:function(e){if(typeof d=="function"){d.call(b)}}};if(collectopia.isDefined(a)){c.error=a}return jQuery.ajax(c)};collectopia.api.MarkerImage=function(a,b,e,f){var c=56,d=60;this.pack=a;this.size=(e)?{width:120,height:56}:{width:60,height:28};this.origin={x:(e)?d:0,y:b*c};this.anchor={x:0,y:(e)?55:27};this.skip_cache=Boolean(f)};collectopia.api.MarkerImage.prototype.toGoogleMarkerImage=function(){return new google.maps.MarkerImage(this.getImageUrl(),new google.maps.Size(this.size.width,this.size.height),new google.maps.Point(this.origin.x,this.origin.y),new google.maps.Point(this.anchor.x,this.anchor.y))};collectopia.api.MarkerImage.prototype.getImageUrl=function(){return collectopia.api.furl("/data/markers/"+this.pack+".png"+(this.skip_cache?"?avoid_cache="+Math.random():""))};