collectopia={isDefined:function(a){return typeof a!="undefined"},isNull:function(a){return isDefined(a)&&a==null},isString:function(a){return typeof a=="string"},isObject:function(a){return typeof a=="object"},isArray:function(a){return jQuery.isArray(a)},isFunction:function(a){return jQuery.isFunction(a)},namespace:function(a){typeof a=="string"&&(a=a.split("."));var b=window,c;for(c in a)collectopia.isDefined(b[a[c]])||(b[a[c]]={}),b=b[a[c]];return b},uuidV4:function(){for(var a=[],b=0;b<36;b++)a[b]=
Math.floor(Math.random()*16);a[14]=4;a[19]=a[19]&3|8;for(b=0;b<36;b++)a[b]="0123456789ABCDEF"[a[b]];a[8]=a[13]=a[18]=a[23]="-";return a.join("")},uuid:this.uuidV4,api:{init:function(a){collectopia.api._server_url=a;a[a.length-1]!="/"&&(collectopia.api._server_url+="/")},furl:function(a){a[0]=="/"&&(a=a.slice(1));return collectopia.api._server_url+a}}};collectopia.api.Error=function(a,b){this.error=a;this.fields=b};
collectopia.api.Form=function(a,b,c){jQuery.extend(this,a);this.object=b;this.submit_action=c};collectopia.api.Form.prototype.getObject=function(){return this.object};collectopia.api.Form.prototype.submit=function(a,b,c){var d=this;this.object.clone().update(a)[this.submit_action](function(a){d.object.update(a.getData(),a.getOptions());collectopia.isFunction(b)&&b.call(d,d)},function(a){collectopia.isFunction(c)&&c.call(d,a)})};collectopia.api.Place=function(a,b){this.update(a,b)};
collectopia.api.Place.prototype.serialize=function(){return jQuery.param(this.getData())};collectopia.api.Place.prototype.getData=function(){data={};for(var a in this)collectopia.isFunction(this[a])||a!="options"&&a[0]!="_"&&(data[a]=this[a]);return jQuery.extend(!0,{},data)};collectopia.api.Place.prototype.getOptions=function(){return jQuery.extend(!0,{},this.options)};collectopia.api.Place.prototype.clone=function(){return new collectopia.api.Place(this.getData(),this.getOptions())};
collectopia.api.Place.prototype.update=function(a,b){var c=this.options;jQuery.extend(this,a,{});this.options=c;if(collectopia.isObject(this.photos))this.photos=this.photos.map(function(a){return new collectopia.api.Photo(a)});this.options=jQuery.extend({skip_marker_cache:!1},this.options,b);return this};
collectopia.api.Place.prototype._process_reply_place=function(a,b,c){collectopia.isDefined(a.error)?collectopia.isFunction(c)&&c.call(this,new collectopia.api.Error(a.error,a.fields)):(this.update(a),collectopia.isFunction(b)&&b.call(this,this))};collectopia.api.Place.prototype._process_fail=function(a,b){collectopia.isFunction(b)&&b.call(this,new collectopia.api.Error(a))};
collectopia.api.Place.prototype.reqCreate=function(a,b){if(collectopia.isDefined(this.id))return!1;var c=this;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/+new"),data:this.getData(),success:function(d){c.options.skip_marker_cache=!0;c._process_reply_place(d,a,b)},error:function(a,e){c._process_fail(e,b)}});return this};
collectopia.api.Place.prototype.reqCreateForm=function(a,b){if(collectopia.isDefined(collectopia.api.Place._cache_reqCreateForm_data))a.call(this,new collectopia.api.Form(collectopia.api.Place._cache_reqCreateForm_data,this,"reqCreate"));else{var c=this;jQuery.ajax({type:"GET",url:collectopia.api.furl("/api/place/+new"),success:function(b){if(collectopia.isFunction(a))collectopia.api.Place._cache_reqCreateForm_data=b,a.call(c,new collectopia.api.Form(b,c,"reqCreate"))},error:b});return this}};
collectopia.api.Place.prototype.reqUpdate=function(a,b){if(!collectopia.isDefined(this.id))return!1;var c=this;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/@"+this.id+"/+edit"),data:this.getData(),success:function(d){c.options.skip_marker_cache=!0;c._process_reply_place(d,a,b)},error:function(a,e){c._process_fail(e,b)}});return this};
collectopia.api.Place.prototype.reqUpdateForm=function(a,b){var c=this;jQuery.ajax({type:"GET",url:collectopia.api.furl("/api/place/@"+this.id+"/+edit"),success:function(b){collectopia.isFunction(a)&&a.call(c,new collectopia.api.Form(b,c,"reqUpdate"))},error:b});return this};
collectopia.api.Place.prototype.reqDelete=function(a,b){if(!collectopia.isDefined(this.id))return!1;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/@"+escape(this.id)+"/+delete"),data:{id:this.id},success:function(){typeof a=="function"&&a.call(place)},error:b});return this};
collectopia.api.Place.prototype.reqRate=function(a,b,c){if(!collectopia.isDefined(this.id))return!1;var d=this;jQuery.ajax({type:"POST",url:collectopia.api.furl("/api/place/@"+escape(this.id)+"/+rate"),data:{id:this.id,rate:a},success:function(a){d._process_reply_place(a,b,c)},error:function(a,b){d._process_fail(b,c)}});return this};collectopia.api.Place.prototype.getMarkerImage=function(){return new collectopia.api.MarkerImage(this.markerpack_hash,this.markerpack_index,!1,this.options.skip_marker_cache)};
collectopia.api.Place.prototype.getFocusedMarkerImage=function(){return new collectopia.api.MarkerImage(this.markerpack_hash,this.markerpack_index,!0,this.options.skip_marker_cache)};collectopia.api.Place.prototype.getVideoUrls=function(){if(typeof this.video_url!=void 0){this.video_url.split(":");var a={};if(a[0]=="youtube")return a.swf="http://www.youtube-nocookie.com/v/"+video[1]+"?autoplay=1&fs=1",a.thumb="http://img.youtube.com/vi/"+video[1]+"/1.jpg",a}};
collectopia.api.Photo=function(a){jQuery.extend(this,{name:"noname",width:0,height:0,size:0},a)};collectopia.api.Photo.prototype.isTemporary=function(){return collectopia.isDefined(this.secret)};collectopia.api.Photo.prototype.getUrl=function(){return collectopia.api.furl("/data/photos/"+this.hash+".jpg")};
collectopia.api.Photo.prototype.getThumbUrl=function(a,b){if(collectopia.isDefined(this.thumb_url))return this.thumb_url;a=collectopia.isDefined(a)?a:154;b=collectopia.isDefined(b)?b:115;return collectopia.api.furl("/data/photos/"+encodeURIComponent(this.hash)+"_thumb_"+encodeURIComponent(a)+"x"+encodeURIComponent(b)+".jpg")};
collectopia.api.Photo.prototype.reqDelete=function(a,b){if(this.isTemporary()){var c=this,d={type:"POST",url:collectopia.api.furl("/api/photo/"+encodeURIComponent(this.secret)+"/+delete-temp"),data:{secret:this.secret},success:function(){typeof a=="function"&&a.call(c)}};collectopia.isDefined(b)&&(d.error=b);return jQuery.ajax(d)}};
collectopia.api.MarkerImage=function(a,b,c,d){this.pack=a;this.size=c?{width:120,height:56}:{width:60,height:28};this.origin={x:c?60:0,y:b*56};this.anchor={x:0,y:c?55:27};this.skip_cache=Boolean(d)};collectopia.api.MarkerImage.prototype.toGoogleMarkerImage=function(){return new google.maps.MarkerImage(this.getImageUrl(),new google.maps.Size(this.size.width,this.size.height),new google.maps.Point(this.origin.x,this.origin.y),new google.maps.Point(this.anchor.x,this.anchor.y))};
collectopia.api.MarkerImage.prototype.getImageUrl=function(){return collectopia.api.furl("/data/markers/"+this.pack+".png"+(this.skip_cache?"?avoid_cache="+Math.random():""))};
